# 이미지 포맷과 압축률로 최적화하기

이미지 압축을 통해, 이미지 품질은 유지하되, 파일 용량을 줄여 페이지 로딩 속도 향상시킬 수 있으며
트래픽 비용 절감 및 Core Web Vitals 개선할 수 있다. (특히 LCP, CLS 등)

결국 퀄리티 조절과 WebP를 사용하자로 귀결되는 내용이지만,
왜 그런지 알아보자.

<br />

### 손실 압축과 무손실 압축

이미지 압축 방식은 크게 **손실 압축(Lossy)**과 무손실 압축(Lossless) 두 가지로 나뉜다.
무손실 압축은 이미지 품질 저하 없이 압축하는 방법이며, 손실 압축은 이미지 품질을 손상시켜 파일을 압축하는 방식이다.
그렇다면 무손실 압축이 더 좋다고 생각할 수 있는데, 댓츠노노
보통 손실 압축 이미지가 용량이 더 적다.

<br />

#### 손실 압축 (Lossy)

손실 압축은 이미지의 시각적 정보를 일부 버리는 방식이다. 사람이 인지하기 어려운 색상 차이, 디테일, 노이즈 등을 제거하거나 단순화하여 용량을 줄인다. JPEG와 WebP가 대표적으로 손실 압축을 사용하는 이미지 포맷이다.

예를 들어 JPEG는 이미지를 블록 단위(보통 8x8 픽셀)로 나눈 뒤, 각 블록에 푸리에 변환(DCT)을 적용한다. 변환된 데이터를 정수화(Quantization)하면서 원본 일부 정보를 버리게 되며, 이 과정에서 디테일이 손실된다. 압축률이 높아질수록 눈에 띄는 화질 저하가 발생하지만, 일반적으로 적절한 수준에서는 사람이 인지하기 어려운 정도로 유지된다.

손실 압축은 파일 크기를 크게 줄일 수 있어 웹 성능 최적화에 유리하지만, 과도한 압축 시 시각적 품질 저하가 발생할 수 있다는 단점이 있다.

<br />

#### 무손실 압축 (Lossless)

무손실 압축은 이미지의 원본 데이터를 그대로 보존하면서 중복되는 데이터나 패턴을 효율적으로 표현해 용량을 줄이는 방식이다. PNG, SVG, WebP(무손실 모드), AVIF(무손실 모드) 등이 무손실 압축을 지원하는 대표적 포맷이다.

예를 들어 PNG는 LZ77 알고리즘을 사용하여 반복되는 데이터를 짧게 표현한다. 이 과정에서 이미지 품질은 전혀 손상되지 않는다. 무손실 압축은 특히 투명도를 유지해야 하거나, 텍스트 및 도형 기반의 이미지, 아이콘, 로고 등에 적합하다.

무손실 압축은 품질 저하가 없지만, 손실 압축에 비해 용량 감소 효과는 상대적으로 적다.

<br />

#### 사람들이 WebP 쓰라고하는데 이유가 뭘까 ?

WebP는 구글이 개발한 포맷으로, 손실 압축과 무손실 압축 모두를 지원한다. 특히 손실 압축 시 JPEG보다 더 뛰어난 압축 효율과 화질을 제공한다. 또한 투명도 지원과 애니메이션 기능까지 포함해 PNG, GIF, JPEG의 장점을 모두 흡수한 올인원 이미지 포맷이다. 따라서 웹 성능과 이미지 품질 모두를 고려할 때 WebP 사용이 권장된다.

<br />

### 실제로는 어떻게 쓸 수 있을까?

대부분의 이미지 CDN은 URL 파라미터로 퀄리티(q)를 받으면, 해당 값을 기준으로 이미지를 다시 인코딩하여 최적화한다. 예를 들어 image.webp?q=80 요청이 들어오면, CDN은 원본 고품질 이미지를 WebP 포맷으로 재인코딩하면서 퀄리티 80에 맞게 손실 압축을 수행한다.

즉, CDN에 고퀄리티 원본 이미지를 저장해두고, 요청 시점에 사용자가 지정한 퀄리티에 맞춰 실시간으로 최적화된 이미지를 제공하는 것이다.

중요한 점은 무조건 퀄리티를 낮춰 용량을 줄이는 것이 항상 최선은 아니다라는 것이다. 용량이 아무리 작아도 이미지가 지나치게 뭉개지거나 흐릿하면 사용자 경험이 오히려 나빠진다.

<br />

### Next.js에서는 딸깍

Next.js의 next/image 컴포넌트는 quality 프로퍼티를 통해 쉽게 이미지 압축률을 조절할 수 있다. 예를 들어 quality={75}라고 지정하면, 내부 이미지 최적화 서버가 해당 값을 기준으로 이미지를 변환하고 압축한다.
이 과정에서 실제로는 Next.js가 이미지를 WebP 같은 고효율 포맷으로 변환하고, 지정한 퀄리티에 맞춰 손실 압축을 수행한다.

#### Sharp는 뭘까 ?

빌드할때마다 sharp를 설치하라고 추천하는데 얘의 역할은 뭘까
sharp는 Node.js 환경에서 이미지 변환 및 최적화를 수행하는 고성능 라이브러리다. Next.js 이미지 최적화 기능에서 기본 이미지 변환과 압축을 담당한다.

- 이미지 크기 조절
- 포맷 변환 (JPEG → WebP 등)
- 퀄리티 조절에 따른 재인코딩

빌드할 때 sharp 설치를 권장하는 이유는, 로컬 또는 서버 환경에서 이미지 최적화가 원활히 이루어지도록 하기 위함이다.
sharp'가 설치되지 않으면 Next.js는 덜 효율적인 다른 방법을 사용하게 됩니다

> https://www.shutterstock.com/ko/blog/raster-vs-vector-file-formats/ > https://oliveyoung.tech/2023-06-09/nextjs-image-optimization/ > https://nextjs.org/docs/app/api-reference/components/image#quality
