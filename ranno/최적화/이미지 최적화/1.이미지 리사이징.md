

# 이미지 리사이징 — 꼭 필요한 크기만 제공하자
먼저 Rendered size와 Intrinsic size 라는 개념을 알아야 한다. 
Rendered size는 실제로 화면에 보여지는 크기를 말하며, Intrinsic size는 이미지의 원본 크기를 말한다. 렌더링 크기가 300px인 컴포넌트인데 2000px 이미지를 로드하는 것은 네트워크 대역폭을 낭비할 뿐 아니라, 로딩 속도에도 영향을 줄 수 있다.

### Retina 대응
일반적으로 이미지를 사용할 때는 Rendered Size의 2배 크기의 이미지를 사용하는 것이 좋다고 한다. 이런 행동을 이미지 최적화 관련 글에서는 "Retina에 대응한다"고 말하는데, 왜 Retina에 대응해야할까 ? 

여기서 말하는 Retina는 Apple 기기에서 사용하는 고해상도 디스플레이 기술이다.
하지만 요즘에는 Apple뿐 아니라 많은 디바이스들이 고해상도 화면을 채택하고 있기 때문에, 사실상 Retina 대응 = 고해상도 대응이라고 볼 수 있다.

이때 중요한 개념이 바로 **DPR(Device Pixel Ratio)** 이다.
DPR은 디바이스의 실제 물리 픽셀 수와 CSS 픽셀 수의 비율을 의미한다.
예를 들어, DPR이 2인 디바이스는 1 CSS 픽셀을 화면에 표시하기 위해 2×2 = 4개의 물리 픽셀을 사용한다.

많은 디바이스들은 고해상도 디스플레이를 사용한다. 1배 크기의 이미지를 사용하면 고해상도 디스플레이에서는 흐리게 보이거나 픽셀이 깨져 보일 수 있기 때문에 2배 크기의 이미지를 사용하는 것이 좋다.

<br/> 

### Retina 대응을 위한 srcset, X descriptor
요즘은 DPR 2 이상인 고해상도 디스플레이도 있다. 이렇게 해상도가 높은 디바이스가 등장할때마다 3배, 4배의 이미지를 로드해야될까? 댓츠 노노, 매우 간편하게 고해상도 대응이 가능하다.

img 태그의 srcset 속성은 반응형 이미지를 위해 설계된 기능이다. srcset은 뷰포트의 크기 뿐만 아니라 화면의 해상도에 따라 적절한 이미지를 브라우저가 알아서 골라준다는 장점이 있다.

```html
<img 
  src="image@1x.jpg"
  srcset="image@1x.jpg 1x, image@2x.jpg 2x, image@3x.jpg 3x"
  alt="예시"
/>
```
브라우저는 **기기의 Device Pixel Ratio (DPR)** 를 감지해서 가장 적절한 이미지를 선택해서 이미지를 로드한다. 예를 들어, DPR이 2인 디바이스에서는 image@2x.jpg 를 로드하고 그린다.


<br/> 

### 반응형 대응을 위한 srcset, W descriptor
해상도 뿐만 아니라, 우리는 모바일화면에 PC에 보여주는 큰 이미지를 가져올 필요도 없다. srcset의 w단위를 사용하면, 뷰포트에 맞는 적절한 크기의 이미지를 로드해서 사용할 수 있다.

```html
<img
  src="image-600.jpg"
  srcset="image-600.jpg 600w, image-1200.jpg 1200w, image-1800.jpg 1800w"
  sizes="(max-width: 600px) 100vw, 600px"
  alt="예시"
/>
```
`srcset`에서는 image-600.jpg는 600px 너비의 이미지이며 image-1200.jpg는 1200px 너비의 이미지라는 것을 브라우저에게 알려주고 있다.`sizes`는 미디어 쿼리로 작성하면 되는데, 브라우저가 어떤 이미지를 골라야 하는가에 대한 조건을 알려준다. 

여기서는 뷰포트가 600px 이하일 때 이미지를 뷰포트 너비만큼(100vw), 그 이상일 때는 600px로 렌더링된다고 알려준다. 현재 뷰포트의 너비가 500px이라면, 이미지는 500px로 렌더링 되니 500px에 가장 가까운 크기인 image-600.jpg를 로드하여 사용하게 된다.

**그러나, srcset에서는 위에서 표현한 x와 w를 함께 쓸 수 없다.**
그렇다면 반응형 대응을 하게 되면 Retina 대응을 할 수 없는 것일까? 
댓츠 노노, 브라우저는 디바이스의 DPR과 뷰포트 너비를 함께 고려해서 가장 적절한 이미지를 선택한다.
예를 들어, 뷰포트가 500px인데 DPR이 2라면, 브라우저는 1000px 크기의 이미지가 필요하다고 판단하고, 1000px에 가까운 image-1200.jpg를 로드하여 사용하게 된다. 

**그래서 W Descriptor를 쓰면 반응형 대응과 고해상도 대응을 동시에 할 수 있다!** 앞에서 해상도나 크기에 맞지 않는 이미지를 불러오는 문제를 `Resolution Switching Problem`이라고 하며, 원본은 같은 이미지이지만, 해상도나 뷰포트에 맞게 다른 크기의 이미지로 교체하는 방식을 `Resolution Switching`이라고 한다. 

반면, Art Direction Problem이라는 것도 존재한다.

<br/>

### 보여줘야되는 이미지가 계속 다르다면 ?? (Art Direction)
반응형 이미지를 다룰 때, 단순히 이미지 크기만 바뀌는 게 아니라 **“화면 크기나 디바이스에 따라 보여줘야 하는 이미지 내용 자체가 달라져야 하는 경우”** 가 있다.PC 화면에선 풍경 전체를 보여줘야 하는데, 모바일 화면에선 그중 인물의 클로즈업만 보여줘야 하는 경우가 그렇다.

이럴 땐 단순히 해상도나 이미지 크기를 조절하는 것만으로는 부족하다.
왜냐하면, 같은 이미지 크기라도 자르고 보여주는 영역이 달라야 하기 때문이다. 
이것이 `Art Direction Problem`이다. 단순한 `Resolution Switching`(이미지 크기나 해상도 변경)과 달리, 화면에 맞게 이미지 “내용”을 다르게 보여줘야 하는 상황이다.

Art Direction Problem은 `<picture>`와 `<source>`로 해결할 수 있다.
```html
<picture>
  <source media="(max-width: 600px)" srcset="image-mobile.jpg" />
  <source media="(min-width: 601px)" srcset="image-desktop.jpg" />
  <img src="image-desktop.jpg" alt="예시" />
</picture>
```
`media` 속성을 통해 뷰포트 조건에 맞는 이미지를 다르게 지정할 수 있다. 만약 매칭되는 이미지가 없다면 가장 마지막에 있는 img 태그를 그리게 된다.

**picture 태그 source 태그 안쓰고 그냥 img 태그를 보였다 안보였다 하면 되지 않을까?** 
댓츠노노, DOM에 img 태그가 있다면 브라우저는 이미지를 로드한다. 즉 모바일에서는 `display :none` 으로 가리더라도 img 태그는 DOM에 존재하므로 이미지를 로드하게 된다. 이런 경우에는 모바일과 PC 모든 이미지를 로드하게 된다. 다만 조건부 렌더링 형태로 img 태그를 DOM에 포함시키지 않는다면 이미지를 로드하지는 않는다. 모든 팀원들에게 이것을 전파하는 것도 일이니 picture 태그를 쓰는 것이 좋다. 

 

<br/>

### 도대체 몇 벌의 이미지를 준비해야되는걸까 
600w 짜리 이미지, 1200w 이미지, 1800w 이미지에다 모바일과 PC 각각 다른 이미지를 사용한다면 최소 한 이미지 구역마다 6개의 이미지를 필요로한다. 앞서 설명한 Retina 대응이나 반응형 이미지 대응을 위해서는 서로 다른 해상도와 크기를 가진 여러 개의 이미지를 준비해야 하는 것처럼 보일 수 있다. 하지만 이건 현실적으로 관리와 유지보수가 너무 어렵다. 

요즘은 이런 문제를 해결해주는 이미지 최적화 서비스나 CDN(Image CDN)이 많다. 대표적으로 이미지 URL에 ?w=300과 같은 쿼리스트링을 붙이기만 하면, 요청한 크기에 맞게 이미지를 리사이징해서 제공해주는 방식이다. 즉, 원본 이미지만 서버에 올려두면 다양한 크기의 이미지를 자동으로 생성하고 제공해준다.
> 우린 빌리쓰가 직접 구현했찌 

이 방식 덕분에 직접 여러 크기의 이미지를 준비하지 않아도 되고, 사용자의 디바이스나 네트워크 상황에 맞는 최적화된 이미지를 전달할 수 있어 매우 효율적이다.


<br/>

### 딸깍, Next/Image
Next.js의 <Image /> 컴포넌트는 이러한 최적화 로직을 내부적으로 자동 처리해준다. 브라우저가 필요한 이미지 크기를 계산하면, Next.js는 그에 맞는 ?w=xxx 쿼리스트링이 붙은 URL로 이미지를 요청하고, 서버는 해당 크기에 맞게 리사이징된 이미지를 응답한다. 결과적으로 개발자는 원본 이미지 하나만 올리면 되고, 다양한 해상도 대응은 Next.js가 알아서 처리해준다.
 
 
그러나, Next/Image는 아직 Art Direction까지 완벽하게 대응하진 않는다. media 쿼리에 따라 다른 이미지를 렌더링하려면 직접 조건부 렌더링 또는 <picture> 사용해야 한다. 
    
또, 우리처럼 웹서버의 부하를 막기위해 이미지를 CDN에 올려두고 사용하는 경우에는 결국 CDN이 ?w=xxx 쿼리스트링이 붙은 URL로 이미지를 잘 내려주도록 만들어야 한다.
> 우린 빌리쓰가 직접 구현했지

    

<br/>
    
> ### 레퍼런스
> https://developer.mozilla.org/en-US/docs/Web/HTML/Guides/Responsive_images
> https://www.heropy.dev/p/5Gl8hX
