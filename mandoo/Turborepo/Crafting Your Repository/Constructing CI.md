## 리모트 캐싱 활성화

CI 환경에서 리모트 캐싱을 활성화하려면, 아래 환경변수들의 세팅이 필요하다

- `TURBO_TOKEN` : 리모트 캐시에 접근하기 위한 Bearer Token
- `TURBO_TEAM` : 리포에 연결된 계정명

## CI 환경에서 태스크 실행하기

`turbo`를 개발/CI 전역환경에 설치함으로써, `turbo.json`에 등록된 태스크들이 모두 같은 동작을 하도록 설정할 수 있다.

### 엔트리포인트 필터링

`--filter` 플래그를 로컬에서 사용하는 것처럼 그대로 사용할 수 있다.

또는 `--affected` 플래그를 사용해서 변경사항이 있는 패키지들에 대해서만 태스크를 실행할 수도 있다.

## Docker

터보리포의 `prune` 서브커맨드를 사용해서 불필요한 의존성과 코드를 이미지에서 제거하고 딱 필요한 만큼의 도커 이미지만 배포할 수 있다.

[Docker | Turborepo](https://turborepo.com/docs/guides/tools/docker)

## 불필요한 태스크/작업 스킵하기

### 영향있는 태스크만 실행하기

`turbo run build --affected` 명령어로 변경사항이 있는 태스크만 실행할 수 있다. 아래와 같은 상황에서 사용할 수 있다.

- 코드 변경사항이 있는 패키지에 대해서만 태스크를 실행하고싶다
- 리모트 캐시를 사용하고 있지 않고, 그럼에도 CI 환경에서 가능한 적은 작업만 하고 싶다
- 리모트 캐싱을 사용중이고, 리포지토리가 크다. 캐시에서 복구할 태스크의 양을 줄이고, 네트워크 비용을 줄여서 속도를 더 높이고 싶다
- `--affected`와 같은 동작을 위해 커스텀하게 뭔가 동작을 정의해서 사용하고있다

**Github Actions에서 `--affected` 사용하기**

CI/CD 파이프라인은 `--affected` 플래그를 사용하기에 최적의 환경이다. 터보리포는 Github Actions의 환경변수(`GITHUB_BASE_REF`)를 통해서 실행환경을 탐지할 수 있다.

PR의 경우에 base 브랜치와 head 브랜치를 비교해서 어떤 변경사항들이 있는지 탐지하고, 영향 있는 패키지들의 태스크만 실행하는 것이 가능하다.

`pull_request`, `pull_request_target` 이벤트에 대해서는 이것이 잘 동작하지만, 일반적인 푸시 이벤트에 대해서는 잘 동작하지 않는다. 이 경우, `GITHUB_EVENT_PATH`를 사용해서 커밋과 베이스 브랜치를 비교한다. 포스푸시나 커밋없이 푸쉬를 하는 경우, 부모 브랜치의 첫번째 커밋과 비교한다.

**`turbo-ignore` 사용하기**

캐시히트에 만족하지 못하고 아예 스킵하고 싶은 경우, `turbo-ignore`를 사용할 수 있다.

1. Repo 클론
2. `turbo-ignore`를 패키지/태스크 대상으로 실행
3. 실행 결과에 따라 이후 아예 스킵을 한다거나 하는 동작을 정의하면 됨

## Best Practices

### 캐싱에 의존하기

터보리포의 캐시를 활용하면 `lint` → `build`로 이어지는 과정에서 많은 부분들이 캐싱의 이점을 받아서 안정적이고 빠른 CI/CD 환경을 구성할 수 있다.

### CI 환경에서 전역 `turbo` 사용하기

전역 `turbo` 버전이 `package.json` 에 명시된 버전과 적어도 major 버전은 일치하도록 설정해주는 것이 좋다.

### CI 환경에서 `turbo run` 사용하기

어떤 명령어가 추가될지 모르기 때문에, `turbo`로 그냥 사용할 수 있어도 `turbo run`으로 실행해주는게 좋다.
