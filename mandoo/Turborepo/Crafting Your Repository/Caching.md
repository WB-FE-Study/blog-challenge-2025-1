Turborepo는 캐싱을 사용해서 같은 일을 두번하지 않게 함으로써 빌드 속도를 높인다. 태스크가 캐싱 가능하다면, Turborepo가 태스크 실행 결과를 복구해서 핑거프린트가 맞다면 캐시를 사용한다.

캐싱 결과를 이용해서 로컬 환경에서 많은 시간을 아낄 수 있으며, 리모트 캐싱 옵션까지 사용한다면 더 강력한 효과를 볼 수 있다. 팀, CI 환경과 캐시를 공유하기 때문이다.

## 리모트 캐싱

Turborepo는 태스크의 실행결과를 `.turbo/cache` 로컬 폴더에 저장한다. 하지만, 조직 전체가 캐시를 공유함으로써 더 높은 캐시 효율을 달성할 수 있다.

### 리모트 캐시 활성화하기

1. 리모트 캐시 프로바이더에 로그인
    1. `npx turbo login`
2. 로컬 저장소를 리모트 캐시에 연결
    1. `npx turbo link`

디폴트로는 Vercel Remote Cache를 사용한다.

## 무엇이 캐싱되는가

Turborepo는 두가지 결과물을 캐싱한다 : 태스크 아웃풋 & 로그

### 태스크 아웃풋

`turbo.json`의 `outputs` 키에 정의되어있는 파일 아웃풋이 캐싱된다. 캐시 히트가 발생하면, Turborepo가 캐시에서 파일들을 복구해온다.

`outputs` 키는 옵셔널 키다. 태스크의 파일 아웃풋을 선언하지 않으면, Turborepo는 캐싱을 하지 않는다.

### 로그

Turborepo는 태스크의 터미널 아웃풋을 캡쳐해두고 캐시 히트가 발생했을 때 로그를 똑같이 보여준다. 리플레이 로그의 상세함 레벨을 `--output-logs` 플래그나 옵션을 통해서 정할 수 있다.

## 태스크 인풋

인풋은 터보리포에 의해 해싱되고, 태스크 실행에 대한 “지문”을 만들게된다. 이 지문이 매칭되면, 캐시 히트가 발생하는 셈이다.

실제로는 터보리포가 두개의 해쉬를 만든다

- 글로벌 해쉬
- 태스크 해쉬

둘 중에 하나라도 바뀐다면, 캐시 미스가 발생하게된다.

### 글로벌 해쉬 인풋

- 루트 `turbo.json` / 패키지 `turbo.json` 의 태스크 데피니션
- 워크스페이스 루트에 영향을 주는 락파일 변화
    - 루트 `package.json`의 변화는 모든 태스크에 캐시 미스가 발생하게 한다
- `globalDependencies` 파일 내용
- `globalEnv`에 리스팅된 변수의 값
- 태스크 런타임에 영향을 주는 플래그 값
    - `--cache-dir`, `--framework-inference` 등
- 임의의 passthrough 인자
    - `turbo build -- --arg=value` 는 `turbo build -- --arg=diff` 와 다른 취급

### 패키지 해쉬 인풋

- 패키지 `turbo.json` 변경
- 패키지에 영향을 주는 락파일 변경사항
- 패키지 `package.json` 변경사항
- 소스컨트롤 내의 파일 변경사항

## 트러블슈팅

### dry run 사용해보기

`--dry` 플래그를 사용하면 태스크를 실제로는 실행하지 않고 실행했을때 어떻게 될지만 볼 수 있다.

### Run Summaries 사용해보기

`--summarize` 플래그를 사용하면 태스크의 인풋/아웃풋 등등에 대한 오버뷰를 볼 수 있다. 두개의 summary를 비교해보면 어떤 부분에서 태스크 간의 차이가 발생했는지 알 수 있다. 이는 아래와 같은 상황에 유용하다.

- 인풋 디버깅
    - 태스크에 다양한 인풋이 있을 수 있다. 캐시 히트가 발생해야할 것 같은데 캐시 미스가 발생한다면, Run Summary를 사용해서 인풋을 비교해볼 수 있다.
- 아웃풋 디버깅
    - 캐시 히트가 발생했지만 원하는대로 아웃풋 파일이 복구되지 않는다면, Run Summary를 활용해서 캐시에서 아웃풋이 어떻게 복구되었는지 확인할 수 있다.

### 캐시 끄기

태스크에 `cache: false`를 세팅해주거나 `--no-cache` 플래그와 함께 실행하면 된다.

### 캐시 덮어쓰기

이미 캐싱된 태스크를 강제로 재실행하고 싶다면, `--force` 플래그를 사용한다. 이는 캐시 읽기를 비활성화시키는 것이지, 쓰기를 비활성화시키는 것이 아니다.

### 태스크 실행보다 캐싱이 오래걸리는 경우

- 태스크 실행이 매우 빨리 끝나는 경우
    - 리모트 캐싱의 네트워크 라운드트립보다 실행이 빨리 끝난다면, 그냥 캐싱안하는게 나을 수 있다
- 아웃풋 결과가 거대한 태스크의 경우
    - 결과 사이즈가 너무 커서 업로드/다운로드 속도가 너무 오래걸릴 수 있다 (완전한 도커 컨테이너 등)
    - 캐싱 안하는 것을 고려해봐야한다.
- 자체 캐싱이 있는 스크립트
    - 몇몇 태스크는 내부적으로 이미 캐싱 동작이 있을 수 있다. 이 경우에는,