## Awaiting mutation callback

mutation callbackì´ ë°˜í™˜í•˜ëŠ” PromiseëŠ” ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì— ì˜í•´ await ë  ìˆ˜ ìˆë‹¤. `invalidateQueries`ë„ Promiseë¥¼ ë°˜í™˜í•´ì£¼ëŠ”ë°, ë§Œì•½ ì›í•˜ëŠ” ì¿¼ë¦¬ë“¤ì´ invalidate ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ì‹¶ë‹¤ë©´ `invalidateQueries`ê°€ ë°˜í™˜í•˜ëŠ” ê°’ì„ awaití•´ì£¼ë©´ ëœë‹¤.

```tsx
{
  // ğŸ‰ will wait for query invalidation to finish
  onSuccess: () => {
    return queryClient.invalidateQueries({
      queryKey: ['posts', id, 'comments'],
    })
  }
}
{
  // ğŸš€ fire and forget - will not wait
  onSuccess: () => {
    queryClient.invalidateQueries({
      queryKey: ['posts', id, 'comments']
    })
  }
}
```

## mutate VS mutateAsync

- `mutate`ëŠ” ì•„ë¬´ê²ƒë„ ë°˜í™˜í•˜ì§€ ì•Šê³ , `mutateAsync`ëŠ” mutationì˜ ê²°ê³¼ë¥¼ ë‹´ì€ Promiseë¥¼ ë°˜í™˜í•´ì¤€ë‹¤
- `mutate`ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ unhandled promise rejectionì— ëŒ€í•œ ê±±ì •ì€ ì•ˆí•´ë„ ëœë‹¤. `mutateAsync`ì˜ ê²½ìš° ì—ëŸ¬ ì¼€ì´ìŠ¤ë¥¼ ì§ì ‘ í•¸ë“¤ë§í•´ì¤˜ì•¼í•œë‹¤.
- ëŒ€ë¶€ë¶„ ì¼€ì´ìŠ¤ì— `mutate`ë¥¼ ì“°ëŠ” ê²ƒì´ ë°”ëŒì§í•˜ë‹¤. ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¥¸ ì²˜ë¦¬ëŠ” callbackì„ ì‚¬ìš©í•˜ë©´ëœë‹¤

## mutate ì½œë°±ì€ í˜¸ì¶œë˜ì§€ ì•Šì„ìˆ˜ë„ ìˆë‹¤

ìˆœì„œìƒ `useMutation`ì— ë„˜ê¸´ ì½œë°±ë“¤ í˜¸ì¶œ â†’ `mutate`ì— ë„˜ê¸´ ì½œë°±ë“¤ í˜¸ì¶œ ìˆœì„œë¡œ ì‹¤í–‰ëœë‹¤. í•˜ì§€ë§Œ `mutate`ì— ë„˜ê¸´ ì½œë°±ë“¤ì€ **mutationì´ ëë‚˜ê¸°ì „ì— ì»´í¬ë„ŒíŠ¸ê°€ ì–¸ë§ˆìš´íŠ¸ëœë‹¤ë©´ ì•„ì˜ˆ í˜¸ì¶œë˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤**.

ë”°ë¼ì„œ, ì•„ë˜ì™€ ê°™ì´ ì½œë°±ì„ ë‚˜ëˆ„ëŠ ê²ƒì´ ê¶Œì¥ëœë‹¤.

- ê¼­ ì‹¤í–‰ë˜ì–´ì•¼í•˜ëŠ” ë¡œì§ â†’ `useMutation` ì½œë°±ìœ¼ë¡œ ë„˜ê¸´ë‹¤
    - query invalidation ë“±
- UIì™€ ê´€ë ¨ëœ ë¡œì§ â†’ `mutate` ì½œë°±ìœ¼ë¡œ ë„˜ê¸´ë‹¤
    - ë¦¬ë‹¤ì´ë ‰ì…˜, í† ìŠ¤íŠ¸ ì•Œë¦¼ ë“±, mutationì´ ëë‚˜ê¸°ì „ì— ì‚¬ìš©ìê°€ í™”ë©´ì„ ë– ë‚œë‹¤ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ì´ UI ë¡œì§ë“¤ì€ ì‹¤í–‰ë˜ì§€ ì•Šì„ ê²ƒì´ë‹¤.

## ì˜¤í”„ë¼ì¸ ìƒí™©ì—ì„œì˜ ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬

v4ë¶€í„° `networkMode` ì˜µì…˜ì´ ìƒê²¨ì„œ ì¿¼ë¦¬ë³„ë¡œ ë„¤íŠ¸ì›Œí¬ ìƒí™©ì´ ì—¬ì˜ì¹˜ì•Šì„ë•Œ ì–´ë–»ê²Œ ë™ì‘í•˜ê²Œ í• ì§€ ì§€ì •í•´ì¤„ ìˆ˜ ìˆë‹¤.

- `online`
    - ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰
    - ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ì—†ëŠ” ìƒí™©ì—ì„œ ì¿¼ë¦¬ ì‹¤í–‰ì‹œ, `fetchStatus`ê°€ `paused`ê°€ ë¨ (`loading/success/error` ìƒíƒœì™€ ë³„ë„)
- `always`
    - ë„¤íŠ¸ì›Œí¬ ìƒí™© ì‹ ê²½ì•ˆì“°ê³  ê·¸ëƒ¥ ë¬´ì¡°ê±´ ì¿¼ë¦¬ ì‹¤í–‰
    - ë„¤íŠ¸ì›Œí¬ë¥¼ í•„ìš”ë¡œ í•˜ì§€ ì•ŠëŠ” `queryFn` ì‚¬ìš©ì‹œ ì ì ˆ
- `offlineFirst`
    - ì²«ë²ˆì§¸ ìš”ì²­ì€ ë¬´ì¡°ê±´ í•˜ê³ , ì‹¤íŒ¨í•˜ë©´ ì¬ì‹œë„ëŠ” ì¼ì‹œì •ì§€í•¨
    - ë¸Œë¼ìš°ì € ìºì‹œ / ë³„ë„ ìºì‹± ë ˆì´ì–´ê°€ ìˆëŠ” ê²½ìš° ìœ ìš©

ì¶”ê°€ì ìœ¼ë¡œ `fetchStatus` ìƒíƒœ ê°’ì— ëŒ€í•œ ë‹¤ì–‘í•œ ì¼€ì´ìŠ¤ë¥¼ ê³ ë ¤í•´ì„œ ë” â€œíƒ„íƒ„í•œâ€ ì•±ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

- `fetching`
    - ì¿¼ë¦¬ê°€ ì‹¤í–‰ì¤‘ì´ê³ , ìš”ì²­ì„ ë³´ë‚¸ìƒíƒœë‹¤
- `paused`
    - ì¿¼ë¦¬ê°€ ì‹¤í–‰ì¤‘ì´ì§€ ì•Šê³ , ì—°ê²°ì„ ë‹¤ì‹œ íšë“í• ë•Œê¹Œì§€ ì¼ì‹œì •ì§€ëœ ìƒíƒœë‹¤
- `idle`
    - ì¿¼ë¦¬ê°€ í˜„ì¬ ë™ì‘í•˜ì§€ ì•Šê³  ìˆë‹¤.

## ë¡œë”©ìƒíƒœ í™œìš©í•˜ê¸° - keepPreviousData

`placeholderData: keepPreviousData`ë¥¼ í™œìš©í•˜ë©´, ì¿¼ë¦¬í‚¤ ë³€ê²½ì„ í†µí•´ ë°ì´í„° í˜ì¹­ì´ ë°œìƒí• ë•Œ ì¿¼ë¦¬í‚¤ê°€ ë°”ë€Œê¸° ì´ì „ ë°ì´í„°ë¥¼ `placeholderData`ë¡œ ì“¸ ìˆ˜ ìˆë‹¤.

```tsx
import { keepPreviousData } from '@tanstack/react-query'

const { data, isPlaceholderData } = useQuery({
  queryKey: ['item', id],
  queryFn: () => fetchItem({ id }),
  // â¬‡ï¸ like thisï¸
  placeholderData: keepPreviousData,
})
```

ì—¬ê¸°ì— `isPlaceolderData` í”Œë˜ê·¸ê¹Œì§€ í™œìš©í•´ì„œ ì ì ˆí•œ UIë¥¼ ë³´ì—¬ì£¼ë©´ ìŠ¤ë¬´ìŠ¤í•œ í™”ë©´ì „í™˜ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

## Suspense Waterfall

`useQuery`ë¥¼ ì‚¬ìš©í• ë•ŒëŠ” Waterfall í˜„ìƒì´ ì¼ì–´ë‚˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, í•œ ì»´í¬ë„ŒíŠ¸ ë‚´ì—ì„œ `useQuery`ë¥¼ ì—¬ëŸ¬ë²ˆí•´ë„ ë¬¸ì œê°€ ì—†ë‹¤.

```tsx
// 1. Use useQuery twice
const issues = useQuery({ queryKey: ['issues'], queryFn: fetchIssues })
const labels = useQuery({ queryKey: ['labels'], queryFn: fetchLabels })

// 2. Use the useQueries hook
const [issues, labels] = useQueries([
  { queryKey: ['issues'], queryFn: fetchIssues },
  { queryKey: ['labels'], queryFn: fetchLabels },
])
```

![](https://velog.velcdn.com/images/mskwon/post/4336fd5c-fe5a-425c-9202-64e5ea500871/image.png)

í•˜ì§€ë§Œ `useSuspenseQuery`ì˜ ê²½ìš°, ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ ì‹œì— ì²«ë²ˆì§¸ë¡œ ì‚¬ìš©ëœ `useSuspenseQuery`ê°€ Promiseë¥¼ ë˜ì§€ê¸°ì— waterfall í˜„ìƒì´ ë°œìƒí•œë‹¤. 

![](https://velog.velcdn.com/images/mskwon/post/164ab71a-5220-4529-aa56-16dac981e767/image.png)


ê³¼ì •ì„ ìì„¸íˆ ì •ë¦¬í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

- ì»´í¬ë„ŒíŠ¸ ë Œë” â†’ ì²«ë²ˆì§¸ ì¿¼ë¦¬ ì½ê¸° ì‹œë„
- ìºì‹œì— ë°ì´í„°ê°€ ì—†ìŒ â†’ suspend ë¨
- ì»´í¬ë„ŒíŠ¸ê°€ ì–¸ë§ˆìš´íŠ¸ ë˜ê³ , fallbackì´ ë Œë”ë§ ë¨
- fetch ì™„ë£Œ, ì»´í¬ë„ŒíŠ¸ íŠ¸ë¦¬ê°€ remountë¨
- ì²«ë²ˆì§¸ ì¿¼ë¦¬ ë°ì´í„°ë¥¼ ìºì‹œë¡œë¶€í„° ì½ã…‡ì–´ì˜´
- ë‘ë²ˆì§¸ ì¿¼ë¦¬ ë°œê²¬, ì½ê¸° ì‹œë„
- ìºì‹œì— ë°ì´í„°ê°€ ì—†ìŒ â†’ suspend ë¨
- ë‘ë²ˆì§¸ ì¿¼ë¦¬ê°€ í˜ì¹­ë¨
- ì»´í¬ë„ŒíŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë Œë”ë§ ë¨

ë”°ë¼ì„œ ë³‘ë ¬ë¡œ í˜ì¹­ì´ ë°œìƒí•˜ì§€ ëª»í•˜ê³ , ë¡œë”© ì‹œê°„ì´ ë” ì˜¤ë˜ ê±¸ë¦¬ëŠ” ê²ƒì²˜ëŸ¼ ëŠê»´ì§ˆ ìˆ˜ ìˆë‹¤. ì´ë¥¼ íšŒí”¼í•˜ëŠ” ê°€ì¥ ì¢‹ì€ ë°©ë²•ì€ ì»´í¬ë„ŒíŠ¸ í•˜ë‚˜ì— ì¿¼ë¦¬ í•˜ë‚˜ë¥¼ ì“°ê±°ë‚˜ ìºì‹œì— í•­ìƒ ë°ì´í„°ê°€ ìˆë„ë¡ í•˜ëŠ” ê²ƒì´ì§€ë§Œ, í˜„ì‹¤ì ìœ¼ë¡œ ê·¸ëŸ¬ê¸° ì‰½ì§€ ì•Šë‹¤.

v5 ì´ì „ì—ëŠ” prefetching ì „ëµ ë“±ì„ í†µí•´ì„œ ì´ë¥¼ í•´ê²°í•´ì•¼ í–ˆì§€ë§Œ, v5ì— [`useSuspenseQueries`](https://tanstack.com/query/latest/docs/framework/react/reference/useSuspenseQueries)ê°€ ë“±ì¥í•´ ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆê²Œ ëë‹¤.